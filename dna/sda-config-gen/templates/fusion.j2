{%- import 'macros.j2' as macros %}
! SDA {{ local }}
! {{ config.fusion[local].hostname }}

! Linknet to TCN1
interface {{ config.fusion[local].interfaces.tcn1.port }}
 description lnk:{{ config.tcn.tcn1.hostname }}:{{ config.tcn.tcn1.interfaces[local].port }}
 no switchport
 vrf forwarding {{ config.fusion[local].interfaces.tcn1.vrf }}
 {{ macros.get_first_ip(config.fusion[local].interfaces.tcn1.linknet) }}
 {{ macros.l3_interface_common(config) }}
!

! Linknet to TCN2
interface {{ config.fusion[local].interfaces.tcn2.port }}
 description lnk:{{ config.tcn.tcn2.hostname }}:{{ config.tcn.tcn2.interfaces[local].port }}
 no switchport
 vrf forwarding {{ config.fusion[local].interfaces.tcn2.vrf }}
 {{ macros.get_first_ip(config.fusion[local].interfaces.tcn2.linknet) }}
 {{ macros.l3_interface_common(config) }}
!

! Linknet to FEXIT1
interface {{ config.fusion[local].interfaces.fexit1.port }}
 description lnk:{{ config.fexit.fexit1.hostname }}:{{ config.fexit.fexit1.interfaces[local].port }}
 no switchport
 no shutdown
 load-interval 30
!
interface {{ config.fusion[local].interfaces.fexit1.port }}.{{ config.fusion[local].interfaces.fexit1.tag }}
 description lnk:{{ config.fexit.fexit1.hostname }}:{{ config.fexit.fexit1.interfaces[local].port }}:Vlan{{ config.fusion[local].interfaces.fexit1.tag }}:GRT
 encapsulation dot1q {{ config.fusion[local].interfaces.fexit1.tag }}
 vrf forwarding {{ config.fusion[local].interfaces.fexit1.vrf }}
 {{ macros.get_first_ip(config.fusion[local].interfaces.fexit1.linknet) }}
 {{ macros.l3_interface_common(config) }}
!

! Linknet to FEXIT2
interface {{ config.fusion[local].interfaces.fexit2.port }}
 description lnk:{{ config.fexit.fexit2.hostname }}:{{ config.fexit.fexit2.interfaces[local].port }}
 no switchport
 no shutdown
 load-interval 30
!
interface {{ config.fusion[local].interfaces.fexit2.port }}.{{ config.fusion[local].interfaces.fexit2.tag }}
 description lnk:{{ config.fexit.fexit2.hostname }}:{{ config.fexit.fexit2.interfaces[local].port }}:Vlan{{ config.fusion[local].interfaces.fexit2.tag }}:GRT
 encapsulation dot1q {{ config.fusion[local].interfaces.fexit2.tag }}
 vrf forwarding {{ config.fusion[local].interfaces.fexit2.vrf }}
 {{ macros.get_first_ip(config.fusion[local].interfaces.fexit2.linknet) }}
 {{ macros.l3_interface_common(config) }}
!

! Deny default route ingress to FUSION
ip prefix-list deny-default-route seq 5 permit 0.0.0.0/0 ge 1
!
router bgp {{ config.fusion.asn }}
 !
 {% include 'bgp_template.j2' %}
 !
 ! TCN1
 address-family ipv4 vrf {{ config.fusion[local].interfaces.tcn1.vrf }}
  {{ macros.bgp_neighbor_last_ip(
    config.fusion[local].interfaces.tcn1.linknet,
    config.tcn.tcn1.asn,
    "eBGP to TCN1:" + config.tcn.tcn1.hostname + ":" + config.tcn.tcn1.interfaces[local].port + ":GRT",
    config.fusion[local].interfaces.tcn1.port,
    prefix_list=true
  )}}
 exit-address-family
 !
 ! TCN2
 address-family ipv4 vrf {{ config.fusion[local].interfaces.tcn2.vrf }}
  {{ macros.bgp_neighbor_last_ip(
    config.fusion[local].interfaces.tcn2.linknet,
    config.tcn.tcn2.asn,
    "eBGP to TCN2:" + config.tcn.tcn2.hostname + ":" + config.tcn.tcn2.interfaces[local].port + ":GRT",
    config.fusion[local].interfaces.tcn2.port,
    prefix_list=true
  )}}
 exit-address-family
 !
 ! FEXIT1
 address-family ipv4 vrf {{ config.fusion[local].interfaces.fexit1.vrf }}
  {{ macros.bgp_neighbor_last_ip(
    config.fusion[local].interfaces.fexit1.linknet,
    config.fexit.asn,
    "eBGP to FEXIT1:" + config.fexit.fexit1.hostname + ":" + config.fexit.fexit1.interfaces[local].port + ":GRT",
    config.fusion[local].interfaces.fexit1.port,
    prefix_list=true
  )}}
 exit-address-family
 !
 ! FEXIT2
 address-family ipv4 vrf {{ config.fusion[local].interfaces.fexit2.vrf }}
  {{ macros.bgp_neighbor_last_ip(
    config.fusion[local].interfaces.fexit2.linknet,
    config.fexit.asn,
    "eBGP to FEXIT2:" + config.fexit.fexit2.hostname + ":" + config.fexit.fexit2.interfaces[local].port + ":GRT",
    config.fusion[local].interfaces.fexit2.port,
    prefix_list=true
  )}}
 !
 exit-address-family
!
